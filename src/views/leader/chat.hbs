{{> leader-tabs route='chat'}}

<div class="container mt-5">
  <div class="row">
    <div class="col-8 offset-2">
      <div class="chat-container border p-3 mb-3 bg-light">
        <div id="chatroomContent"></div>

        <div class="input-group mb-3">
          <input type="text" class="form-control" placeholder="Type your message..." id="messageInput"
            aria-describedby="button-addon2">

          <select id="groupSelect">
            <option value="0">所有人</option>
            {{#each group}}
            <option value="{{this.id}}">{{this.name}}</option>
            {{/each}}
          </select>

          <button class="btn btn-primary mx-2" type="button" id="sendMessageBtn">Send</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // 建立與ws連線
  const ws = new WebSocket("ws://localhost:3000")

  // 連線
  ws.addEventListener("open", (event) => {
    console.log('連線成功')

    setupFormSubmission(ws)

  })


  // 監聽message
  ws.addEventListener("message", (event) => {

    const msg = JSON.parse(event.data)
    const chatroomContent = document.getElementById('chatroomContent')
    console.log(msg)
    if (msg.userName) {
      chatroomContent.innerHTML += `<p class="p-2 rounded">${msg.userName}<對${msg.groupName}說>:${msg.context}</p>`
    }
    else {
      chatroomContent.innerHTML += `<p class="p-2 rounded">${msg.context}</p>`
    }
  })

  function setupFormSubmission(ws) {
    const sendMessageBtn = document.getElementById('sendMessageBtn')
    const messageInput = document.getElementById('messageInput')

    sendMessageBtn.addEventListener('click', async function () {
      const message = messageInput.value
      const groupId = await getGroupId()

      const msg = {
        context: `${message}`,
        groupId
      }
      ws.send(JSON.stringify(msg))

      messageInput.value = ''

    })

  }


  function getGroupId() {
    return new Promise(resolve => {
      const groupSelect = document.getElementById('groupSelect')
      groupSelect.addEventListener('change', function () {
        const groupId = this.value
        const selectGroupId = groupId === '' ? '0' : groupId
        resolve(selectGroupId)
      })
      resolve(groupSelect.value)
    })
  }

</script>